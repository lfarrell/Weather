d3.csv("../us_temp_all.csv",function(d){function w(a){a=d3.select(a);a.attr("width",r+e.left+e.right).attr("height",k+e.top+e.bottom);a.append("g").attr("class","x axis").attr("transform","translate("+e.left+","+(k+e.top)+")").call(C);a.append("text").attr("x",r/2).attr("y",k+e.bottom).style("text-anchor","middle").text("Month");a.append("g").attr("class","y axis").attr("transform","translate("+e.left+","+e.top+")").call(t);a.append("text").attr("transform","rotate(-90)").attr("x",-k/2).attr("y",
    6).attr("dy",".71em").style("text-anchor","end").text("Temperature Anomaly");return a}function f(){var a={1890:{counts:5,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1900:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1910:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1920:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,
    "07":0,"08":0,"09":0,10:0,11:0,12:0}},1930:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1940:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1950:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1960:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1970:{counts:10,month_totals:{"01":0,
    "02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1980:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1990:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},2E3:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},2010:{counts:5,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,
    12:0}}};d3.nest().key(function(a){return a.decade}).entries(c).forEach(function(b){b.values.forEach(function(b){b.values.forEach(function(c){a[b.decade].month_totals[c.month]+=c.anomaly})})});for(var b in a)for(var d in a[b])for(var x in a[b][d])a[b][d][x]=(a[b][d][x]/a[b].counts).toFixed(1);return a}function y(){var a=[],b;for(b in n){var c=[],d;for(d in n[b].month_totals)c.push({month:d,anomaly:n[b].month_totals[d]});var e=_.pluck(c,"anomaly"),e=(_.reduce(e,function(a,b){return+a+ +b})/e.length).toFixed(1);
    a.push({key:b,anomaly_avg:e,values:_.sortByOrder(c,["month"],["asc"])})}return a}function z(){for(var a=[],b=0;b<c.length;b++)a.push(_.pluck(c[b].values,"anomaly"));return[].concat.apply([],a)}d.forEach(function(a){a.value=+a.value;a.anomaly=+a.anomaly;a.decade=a.year.substr(0,3)+"0"});var g=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),e={top:20,right:25,left:50,bottom:75},A=d3.time.format("%m").parse,B=_.sortByOrder(d,["state","year","month"],["asc","asc","asc"]),r=
    window.innerWidth-100-e.right-e.left,k=700-e.top-e.bottom;d=B.filter(function(a){return"US"==a.state});var c=d3.nest().key(function(a){return a.year}).entries(d),p=lineCount(c),c=avg_anomalies(c),u=d3.time.scale().domain(d3.extent(d,function(a){return A(a.month)})).range([0,r]),h=d3.scale.linear().domain(d3.extent(d,function(a){return a.anomaly}).reverse()).range([0,k]),C=d3.svg.axis().scale(u).orient("bottom").ticks(d3.time.months,1).tickFormat(d3.time.format("%b")),t=d3.svg.axis().scale(h).orient("left"),
    q=d3.svg.line().x(function(a){return u(A(a.month))}).y(function(a){return h(a.anomaly)});d=w("#avg_temps",u,h);for(var l=0;l<p;l++)d.append("g").append("path").attr("d",q(c[l].values)).attr("class","temp_lines").attr("id","year_"+l).attr("transform","translate("+e.left+","+e.top+")").style("stroke",function(a){if(l>=p-11)return"red"}).on("mouseover",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke","slategray").style("stroke-width",3);g.transition().duration(200).style("opacity",
    .9);g.html("<h5 class='center'>"+c[b].values[0].year+"</h5><p class='center'>Temp Anomalies in Degrees<br/> Fahrenheit</p><p class='center'>Avg. Temp Anomaly: "+c[b].anomaly_avg+"</p><ul class='columns'><li>Jan: "+c[b].values[0].anomaly+"</li><li>Feb: "+c[b].values[1].anomaly+"</li><li>Mar: "+c[b].values[2].anomaly+"</li><li>Apr: "+c[b].values[3].anomaly+"</li><li>May: "+c[b].values[4].anomaly+"</li><li>Jun: "+c[b].values[5].anomaly+"</li><li>Jul: "+c[b].values[6].anomaly+"</li><li>Aug: "+c[b].values[7].anomaly+
    "</li><li>Sep: "+c[b].values[8].anomaly+"</li><li>Oct: "+c[b].values[9].anomaly+"</li><li>Nov: "+(void 0!==c[b].values[10].anomaly?c[b].values[10].anomaly:"N/A")+"</li><li>Dec: "+(void 0!==c[b].values[11].anomaly?c[b].values[11].anomaly:"N/A")+"</li></ul>").style("top",d3.event.pageY-108+"px").style("left",d3.event.pageX-28+"px")}).on("mouseout",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke",function(a){return b>=p-11?"red":"lightgray"}).style("stroke-width",1.5);g.transition().duration(500).style("opacity",
        0)});var n=f(),c=y(),v=z();h.domain(d3.extent(v,function(a){return+a}).reverse());d=w("#avg_temps_decade");for(var m=0;m<c.length;m++)d.append("g").append("path").attr("d",q(c[m].values)).attr("class","decade_lines").attr("id","decade_"+m).attr("transform","translate("+e.left+","+e.top+")").style("stroke",function(a){if(.5<=c[m].anomaly_avg)return"red"}).on("mouseover",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke","slategray").style("stroke-width",3);g.transition().duration(200).style("opacity",
    .9);g.html("<h5 class='center'>"+c[b].key+"'s</h5><p class='center'>Temp Anomalies in Degrees<br/> Fahrenheit</p><p class='center'>Avg. Temp Anomaly: "+c[b].anomaly_avg+"</p><ul class='columns'><li>Jan: "+c[b].values[0].anomaly+"</li><li>Feb: "+c[b].values[1].anomaly+"</li><li>Mar: "+c[b].values[2].anomaly+"</li><li>Apr: "+c[b].values[3].anomaly+"</li><li>May: "+c[b].values[4].anomaly+"</li><li>Jun: "+c[b].values[5].anomaly+"</li><li>Jul: "+c[b].values[6].anomaly+"</li><li>Aug: "+c[b].values[7].anomaly+
    "</li><li>Sep: "+c[b].values[8].anomaly+"</li><li>Oct: "+c[b].values[9].anomaly+"</li><li>Nov: "+c[b].values[10].anomaly+"</li><li>Dec: "+c[b].values[11].anomaly+"</li></ul>").style("top",d3.event.pageY-108+"px").style("left",d3.event.pageX-28+"px")}).on("mouseout",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke",function(a){return.5<=c[b].anomaly_avg?"red":"lightgray"}).style("stroke-width",1.5);g.transition().duration(500).style("opacity",0)});d3.select("#state").on("change",
    function(){var a=this.options[this.selectedIndex].innerHTML,b=d3.select(this),d=b.property("value"),e=B.filter(function(a){return a.state==d});c=d3.nest().key(function(a){return a.year}).entries(e);c=avg_anomalies(c);h.domain(d3.extent(e,function(a){return a.anomaly}).reverse());d3.select("#avg_temps g.y").transition().duration(1E3).ease("sin-in-out").call(t);for(e=0;e<p;e++)d3.select("#year_"+e).transition().duration(1400).ease("sin-in-out").attr("d",q(c[e].values));n=f();c=y();v=z();h.domain(d3.extent(v,
        function(a){return+a}).reverse());d3.select("#avg_temps_decade g.y").transition().duration(1E3).ease("sin-in-out").call(t);for(e=0;e<c.length;e++)d3.select("#decade_"+e).transition().duration(1400).ease("sin-in-out").attr("d",q(c[e].values));d3.selectAll(".selected_state").text(a);b.property("value","")});d3.selectAll(".row").classed("hide",!1);d3.select("#note").classed("hide",!0)});function lineCount(d){return Math.round(d.length)}function line_id(d){return d.split("_")[1]}
function avg_anomalies(d){d.forEach(function(d){var f=_.pluck(d.values,"anomaly"),f=_.reduce(f,function(d,f){return d+f},0);d.anomaly_avg=(f/d.values.length).toFixed(1);d.decade=d.key.substr(0,3)+"0"});return d};
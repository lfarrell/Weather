d3.csv("../us_temp_all.csv",function(d){function g(a){a=d3.select(a);a.attr("width",u+f.left+f.right).attr("height",m+f.top+f.bottom);a.append("g").attr("class","x axis").attr("transform","translate("+f.left+","+(m+f.top)+")").call(C);a.append("text").attr("x",u/2).attr("y",m+f.bottom).style("text-anchor","middle").text("Month");a.append("g").attr("class","y axis").attr("transform","translate("+f.left+","+f.top+")").call(v);a.append("text").attr("transform","rotate(-90)").attr("x",-m/2).attr("y",
    6).attr("dy",".71em").style("text-anchor","end").text("Temperature Anomaly");return a}function h(){var a={1890:{counts:5,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1900:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1910:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1920:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,
    "07":0,"08":0,"09":0,10:0,11:0,12:0}},1930:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1940:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1950:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1960:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1970:{counts:10,month_totals:{"01":0,
    "02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1980:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},1990:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},2E3:{counts:10,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,12:0}},2010:{counts:5,month_totals:{"01":0,"02":0,"03":0,"04":0,"05":0,"06":0,"07":0,"08":0,"09":0,10:0,11:0,
    12:0}}};d3.nest().key(function(a){return a.decade}).entries(c).forEach(function(b){b.values.forEach(function(b){b.values.forEach(function(c){a[b.decade].month_totals[c.month]+=c.anomaly})})});for(var b in a)for(var e in a[b])for(var d in a[b][e])a[b][e][d]=(a[b][e][d]/a[b].counts).toFixed(1);return a}function y(){var a=[],b;for(b in q){var c=[],e;for(e in q[b].month_totals)c.push({month:e,anomaly:q[b].month_totals[e]});var d=_.pluck(c,"anomaly"),d=(_.reduce(d,function(a,b){return+a+ +b})/d.length).toFixed(1);
    a.push({key:b,anomaly_avg:d,values:_.sortByOrder(c,["month"],["asc"])})}return a}function z(){for(var a=[],b=0;b<c.length;b++)a.push(_.pluck(c[b].values,"anomaly"));return[].concat.apply([],a)}d.forEach(function(a){a.value=+a.value;a.anomaly=+a.anomaly;a.decade=a.year.substr(0,3)+"0"});var k=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),f={top:20,right:25,left:50,bottom:75},A=d3.time.format("%m").parse,B=_.sortByOrder(d,["state","year","month"],["asc","asc","asc"]),u=
    window.innerWidth-100-f.right-f.left,m=700-f.top-f.bottom;d=B.filter(function(a){return"US"==a.state});var c=d3.nest().key(function(a){return a.year}).entries(d),r=lineCount(c),e=c=avg_anomalies(c),w=d3.time.scale().domain(d3.extent(d,function(a){return A(a.month)})).range([0,u]),l=d3.scale.linear().domain(d3.extent(d,function(a){return a.anomaly}).reverse()).range([0,m]),C=d3.svg.axis().scale(w).orient("bottom").ticks(d3.time.months,1).tickFormat(d3.time.format("%b")),v=d3.svg.axis().scale(l).orient("left"),
    t=d3.svg.line().x(function(a){return w(A(a.month))}).y(function(a){return l(a.anomaly)});d=g("#avg_temps",w,l);for(var n=0;n<r;n++)d.append("g").append("path").attr("d",t(c[n].values)).attr("class","temp_lines").attr("id","year_"+n).attr("transform","translate("+f.left+","+f.top+")").style("stroke",function(a){if(n>=r-11)return"red"}).on("mouseover",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke","slategray").style("stroke-width",3);k.transition().duration(200).style("opacity",
    .9);k.html("<h5 class='center'>"+e[b].values[0].year+"</h5><p class='center'>Temp Anomalies in Degrees<br/> Fahrenheit</p><p class='center'>Avg. Temp Anomaly: "+e[b].anomaly_avg+"</p><ul class='columns'><li>Jan: "+e[b].values[0].anomaly+"</li><li>Feb: "+e[b].values[1].anomaly+"</li><li>Mar: "+e[b].values[2].anomaly+"</li><li>Apr: "+e[b].values[3].anomaly+"</li><li>May: "+e[b].values[4].anomaly+"</li><li>Jun: "+e[b].values[5].anomaly+"</li><li>Jul: "+e[b].values[6].anomaly+"</li><li>Aug: "+e[b].values[7].anomaly+
    "</li><li>Sep: "+e[b].values[8].anomaly+"</li><li>Oct: "+e[b].values[9].anomaly+"</li><li>Nov: "+(void 0!==e[b].values[10].anomaly?e[b].values[10].anomaly:"N/A")+"</li><li>Dec: "+(void 0!==e[b].values[11].anomaly?e[b].values[11].anomaly:"N/A")+"</li></ul>").style("top",d3.event.pageY-108+"px").style("left",d3.event.pageX-28+"px")}).on("mouseout",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke",function(a){return b>=r-11?"red":"lightgray"}).style("stroke-width",1.5);k.transition().duration(500).style("opacity",
        0)});var q=h(),c=y(),x=z();l.domain(d3.extent(x,function(a){return+a}).reverse());d=g("#avg_temps_decade");for(var p=0;p<c.length;p++)d.append("g").append("path").attr("d",t(c[p].values)).attr("class","decade_lines").attr("id","decade_"+p).attr("transform","translate("+f.left+","+f.top+")").style("stroke",function(a){if(.5<=c[p].anomaly_avg)return"red"}).on("mouseover",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke","slategray").style("stroke-width",3);k.transition().duration(200).style("opacity",
    .9);k.html("<h5 class='center'>"+c[b].key+"'s</h5><p class='center'>Temp Anomalies in Degrees<br/> Fahrenheit</p><p class='center'>Avg. Temp Anomaly: "+c[b].anomaly_avg+"</p><ul class='columns'><li>Jan: "+c[b].values[0].anomaly+"</li><li>Feb: "+c[b].values[1].anomaly+"</li><li>Mar: "+c[b].values[2].anomaly+"</li><li>Apr: "+c[b].values[3].anomaly+"</li><li>May: "+c[b].values[4].anomaly+"</li><li>Jun: "+c[b].values[5].anomaly+"</li><li>Jul: "+c[b].values[6].anomaly+"</li><li>Aug: "+c[b].values[7].anomaly+
    "</li><li>Sep: "+c[b].values[8].anomaly+"</li><li>Oct: "+c[b].values[9].anomaly+"</li><li>Nov: "+c[b].values[10].anomaly+"</li><li>Dec: "+c[b].values[11].anomaly+"</li></ul>").style("top",d3.event.pageY-108+"px").style("left",d3.event.pageX-28+"px")}).on("mouseout",function(a){a=d3.select(this);var b=line_id(a.attr("id"));a.style("stroke",function(a){return.5<=c[b].anomaly_avg?"red":"lightgray"}).style("stroke-width",1.5);k.transition().duration(500).style("opacity",0)});d3.select("#state").on("change",
    function(){var a=this.options[this.selectedIndex].innerHTML,b=d3.select(this),d=b.property("value"),f=B.filter(function(a){return a.state==d});e=c=d3.nest().key(function(a){return a.year}).entries(f);e=avg_anomalies(e);l.domain(d3.extent(f,function(a){return a.anomaly}).reverse());d3.select("#avg_temps g.y").transition().duration(1E3).ease("sin-in-out").call(v);for(f=0;f<r;f++)d3.select("#year_"+f).transition().duration(1400).ease("sin-in-out").attr("d",t(e[f].values));q=h();c=y();x=z();l.domain(d3.extent(x,
        function(a){return+a}).reverse());d3.select("#avg_temps_decade g.y").transition().duration(1E3).ease("sin-in-out").call(v);for(var g=0;g<c.length;g++)d3.select("#decade_"+g).transition().duration(1400).ease("sin-in-out").attr("d",t(c[g].values)).style("stroke",function(a){if(.5<=c[g].anomaly_avg)return"red"});d3.selectAll(".selected_state").text(a);b.property("value","")});d3.selectAll(".row").classed("hide",!1);d3.select("#note").classed("hide",!0)});
function lineCount(d){return Math.round(d.length)}function line_id(d){return d.split("_")[1]}function avg_anomalies(d){d.forEach(function(d){var h=_.pluck(d.values,"anomaly"),h=_.reduce(h,function(d,g){return d+g},0);d.anomaly_avg=(h/d.values.length).toFixed(1);d.decade=d.key.substr(0,3)+"0"});return d};